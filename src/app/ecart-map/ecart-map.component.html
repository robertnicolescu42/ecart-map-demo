<div
  class="container d-flex justify-content-center align-items-center min-vh-100"
>
  <div class="text-center map-container border rounded p-3">
    <p class="h3 p-2 map-title text-black">eCart map example</p>
    <hr />
    <div>
      <button
        class="btn btn-sm"
        (click)="editMode = !editMode"
        [ngClass]="editMode ? 'btn-danger' : 'btn-primary'"
      >
        <i class="fa fa-wand-magic-sparkles"></i> Switch to
        {{ editMode ? "Normal" : "Edit" }} mode
      </button>
    </div>
    <div class="p-2 position-relative" *ngIf="stoppers">
      <svg
        [attr.width]="svgDimensions.width"
        [attr.height]="svgDimensions.height"
        class="svg-map"
      >
        <!-- Draw lines between stoppers (connections) -->
        <ng-container *ngFor="let stopper of stoppers">
          <line
            *ngIf="stopper.connections.E"
            [attr.x1]="stopper.x"
            [attr.y1]="stopper.y"
            [attr.x2]="getStopperById(stopper.connections.E).x"
            [attr.y2]="getStopperById(stopper.connections.E).y"
            stroke="black"
            stroke-width="2"
          />
          <line
            *ngIf="stopper.connections.S"
            [attr.x1]="stopper.x"
            [attr.y1]="stopper.y"
            [attr.x2]="getStopperById(stopper.connections.S).x"
            [attr.y2]="getStopperById(stopper.connections.S).y"
            stroke="black"
            stroke-width="2"
          />
        </ng-container>

        <!-- Draw stoppers (circles) -->
        <circle
          *ngFor="let stopper of stoppers"
          [attr.cx]="stopper.x"
          [attr.cy]="stopper.y"
          [attr.fill]="stopper.color"
          r="15"
          stroke="black"
          stroke-width="2"
          [tooltip]="popTemplate"
          [container]="'body'"
          tooltipPlacement="top"
          tooltipClass="custom-tooltip"
          (mouseover)="showDetails(stopper)"
          (mouseout)="hideDetails()"
          (click)="onStopperClick(stopper, $event)"
        ></circle>
        <!-- [ngClass]="{
            'ecart-available': stopper.data.isEcartAvailable,
            'ecart-unavailable': !stopper.data.isEcartAvailable
          }" -->
      </svg>

      <!-- Tooltip Template -->
      <ng-template #popTemplate>
        <div *ngIf="hoveredStopper" class="text-start">
          <strong>ID:</strong> {{ hoveredStopper.id }}<br />
          <strong>eCart ID:</strong> {{ hoveredStopper.data.eCartId }}<br />
          <strong>Description:</strong> {{ hoveredStopper.data.description
          }}<br />
          <strong>Arrival Time:</strong> {{ hoveredStopper.data.arrivalTime }}
        </div>
      </ng-template>

      <!-- Contextual Menu -->
      <div
        class="contextual-menu bg-light p-3 border rounded shadow contextual-menu"
      >
        <div *ngIf="contextualMenuVisible; else noStopperSelected">
          <h5>Stopper: {{ selectedStopper?.id }}</h5>
          <p>
            <strong>eCart ID:</strong> {{ selectedStopper?.data.eCartId }}<br />
            <strong>Description:</strong> {{ selectedStopper?.data.description
            }}<br />
          </p>
          <hr />

          <div class="dropdown-divider"></div>
          <div class="position-relative text-center neighbor-buttons">
            <button
              class="btn btn-secondary btn-sm position-absolute top-0 start-50 translate-middle-x"
              (click)="prepareAddStopper('N')"
            >
              <i class="fas fa-arrow-up"></i> {{ addRemoveNeighborLabel("N") }}
            </button>
            <button
              class="btn btn-secondary btn-sm position-absolute start-0 top-50 translate-middle-y"
              (click)="prepareAddStopper('W')"
            >
              <i class="fas fa-arrow-left"></i>
              {{ addRemoveNeighborLabel("W") }}
            </button>
            <button
              class="btn btn-secondary btn-sm position-absolute top-50 end-0 translate-middle-y"
              (click)="prepareAddStopper('E')"
            >
              {{ addRemoveNeighborLabel("E") }}
              <i class="fas fa-arrow-right"></i>
            </button>
            <button
              class="btn btn-secondary btn-sm position-absolute bottom-0 start-50 translate-middle-x"
              (click)="prepareAddStopper('S')"
            >
              <i class="fas fa-arrow-down"></i>
              {{ addRemoveNeighborLabel("S") }}
            </button>
          </div>

          <!-- Dropdown to add stopper -->
          <div *ngIf="showStopperDropdown">
            <label for="stopperSelect">Select a Stopper:</label>
            <select
              id="stopperSelect"
              class="form-select"
              [(ngModel)]="selectedStopperToAdd"
            >
              <option
                *ngFor="let stopper of possibleStoppers"
                [ngValue]="stopper"
              >
                {{ stopper.id }}
                {{ -stopper.data.description || "" }}
              </option>
            </select>
            <button
              class="btn btn-primary mt-2 w-100"
              (click)="addStopper(selectedDirection)"
            >
              Add Stopper
            </button>
          </div>

          <div class="dropdown-divider"></div>
          <hr />

          <button
            class="btn btn-sm btn-primary my-2 w-100"
            (click)="editStopper()"
          >
            <i class="fas fa-edit"></i> Edit Stopper
          </button>
          <button
            class="btn btn-sm btn-danger w-100 my-2"
            (click)="removeStopper()"
          >
            <i class="fas fa-trash px-1"></i> Remove Stopper
          </button>
          <button
            class="btn btn-sm btn-secondary w-100 my-2"
            (click)="closeMenu()"
          >
            <i class="fas fa-close"></i> Close
          </button>
        </div>
      </div>

      <!-- When no stopper is selected and stoppers array is empty -->
      <ng-template #noStopperSelected>
        <div *ngIf="stoppers.length === 0" class="alert alert-info">
          No stoppers available. Click the button below to add the first
          stopper.
          <button
            class="btn btn-primary mt-2"
            (click)="prepareAddFirstStopper()"
          >
            Add First Stopper
          </button>
        </div>
        <div *ngIf="stoppers.length > 0" class="alert alert-warning">
          Please click on a stopper to view or edit details.
        </div>
      </ng-template>
    </div>
  </div>
</div>
